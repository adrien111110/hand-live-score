<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Live Pro - SCHL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        .score-font { font-family: 'Orbitron', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-lg mb-4 text-center">
        <div class="flex justify-center items-center gap-2 text-slate-400 text-[10px] font-bold uppercase tracking-widest">
            <span id="display-location">Chargement...</span>
            <span class="text-slate-700">‚Ä¢</span>
            <span id="display-start-time">--:--</span>
        </div>
        <div id="display-period" class="mt-2 inline-block bg-slate-800 text-slate-300 text-[9px] px-3 py-1 rounded-full border border-slate-700 font-bold uppercase">1√®re P√©riode</div>
    </div>

    <div class="text-center mb-6">
        <div id="timer-display" class="score-font text-6xl text-amber-400 drop-shadow-[0_0_10px_rgba(251,191,36,0.3)]">00:00</div>
    </div>

    <div class="w-full max-w-lg bg-slate-900 rounded-3xl p-6 shadow-2xl border border-slate-800">
        <div class="flex justify-between items-start">
            <div class="flex-1 text-center flex flex-col items-center">
                <img id="home-logo" src="" class="w-14 h-14 mb-2 object-contain hidden">
                <h2 id="home-name" class="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-tighter">DOMICILE</h2>
                <div id="score-home" class="score-font text-6xl mb-4">0</div>
                <div id="penalties-home" class="space-y-1 w-full"></div>
            </div>
            <div class="text-4xl text-slate-800 font-bold mt-16 px-2">:</div>
            <div class="flex-1 text-center flex flex-col items-center">
                <img id="away-logo" src="" class="w-14 h-14 mb-2 object-contain hidden">
                <h2 id="away-name" class="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-tighter">EXT√âRIEUR</h2>
                <div id="score-away" class="score-font text-6xl mb-4">0</div>
                <div id="penalties-away" class="space-y-1 w-full"></div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-lg mt-6 grid grid-cols-2 gap-4">
        <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4">
            <h3 class="text-[9px] uppercase tracking-widest text-slate-500 font-bold mb-3 italic">üî• Top Buteurs</h3>
            <div id="stats-scorers" class="space-y-2">
                <p class="text-[10px] text-slate-600 italic">Aucun but...</p>
            </div>
        </div>

        <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
            <h3 class="text-[9px] uppercase tracking-widest text-slate-500 font-bold mb-1 italic">üß§ Arr√™t Gardien SCHL</h3>
            <div id="stats-gk-percent" class="score-font text-3xl text-indigo-400">0%</div>
            <div id="stats-gk-details" class="text-[9px] text-slate-500 uppercase font-bold mt-1">0 Arr√™t / 0 Tir</div>
        </div>
    </div>

    <div class="w-full max-w-lg mt-6">
        <h3 class="text-[10px] uppercase tracking-widest text-slate-500 mb-3 px-2 font-bold italic">Fil du match</h3>
        <div id="timeline-container" class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
            <p class="text-slate-600 text-xs italic p-4 text-center">En attente d'√©v√©nements...</p>
        </div>
    </div>

    <div id="admin-panel" class="hidden w-full max-w-md mt-8 space-y-6 bg-slate-900/95 p-6 rounded-3xl border border-slate-700 shadow-2xl">
        <div class="flex flex-col items-center gap-4">
            <select id="select-period" onchange="changePeriod(this.value)" class="bg-slate-800 text-white text-xs p-3 rounded-xl border border-slate-700 w-full focus:outline-none">
                <option value="1√®re P√©riode">1√®re P√©riode</option>
                <option value="Mi-Temps">Mi-Temps</option>
                <option value="2√®me P√©riode">2√®me P√©riode</option>
                <option value="Match Termin√©">Match Termin√©</option>
            </select>
            
            <div class="flex items-center gap-4">
                <button onclick="adjustTimer(-5)" class="w-12 h-12 rounded-full bg-slate-800 border border-slate-700 text-slate-400 font-bold">-5s</button>
                <button id="btn-timer" onclick="toggleTimer()" class="px-10 py-3 rounded-full font-bold bg-green-500 text-black shadow-lg shadow-green-500/20 active:scale-95 transition-all">START</button>
                <button onclick="adjustTimer(5)" class="w-12 h-12 rounded-full bg-slate-800 border border-slate-700 text-slate-400 font-bold">+5s</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-slate-800">
            <div class="space-y-3 text-center">
                <span class="text-[10px] font-bold text-slate-500 uppercase">Maison</span>
                <button onclick="updateScore('score_home', 1)" class="w-full bg-white text-black font-black py-5 rounded-2xl active:scale-95 transition-all">+1 BUT</button>
                <button onclick="addPenalty('home')" class="w-full bg-orange-600/10 border border-orange-600 text-orange-500 py-2 rounded-xl text-[10px] font-bold uppercase">Exclusion 2'</button>
            </div>
            <div class="space-y-3 text-center">
                <span class="text-[10px] font-bold text-slate-500 uppercase">Ext√©rieur</span>
                <button onclick="updateScore('score_away', 1)" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl active:scale-95 transition-all">+1 BUT</button>
                <button onclick="addPenalty('away')" class="w-full bg-orange-600/10 border border-orange-600 text-orange-500 py-2 rounded-xl text-[10px] font-bold uppercase">Exclusion 2'</button>
            </div>
        </div>
        <button onclick="logGkSave()" class="w-1/2 mt-2 bg-indigo-600/10 border border-indigo-500 text-indigo-400 py-2 rounded-xl text-[10px] font-bold uppercase">Arr√™t Gardien SCHL</button>
        <button onclick="resetTimer()" class="w-full text-[9px] text-slate-700 uppercase tracking-[0.3em] pt-4">R√©initialiser Match</button>
    </div>

    <div id="player-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl">
            <h3 class="text-center font-bold text-slate-400 text-sm mb-4 uppercase tracking-widest">Qui a marqu√© ?</h3>
            <button onclick="confirmGoal(null)" class="w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl mb-4 font-bold border border-slate-700 transition-colors">üë§ Buteur Non Pr√©cis√©</button>
            <div id="players-list" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar"></div>
            <button onclick="closeModal()" class="w-full mt-6 text-slate-500 text-[10px] uppercase font-bold tracking-widest">Annuler</button>
        </div>
    </div>

    <script>
        // CONFIGURATION SUPABASE
        const supabaseUrl = 'https://rmfcixwuyltwpotijozd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZmNpeHd1eWx0d3BvdGlqb3pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjQyMzgsImV4cCI6MjA4NTYwMDIzOH0.IW9b7431_xQlM1rydhOO551QgIq3bVEOgM5KllSzfTs';
        const MATCH_ID = '7d6708ba-b37c-4719-8aea-da68cf7d6147';
        const ADMIN_SECRET = "coach2026"; 
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let matchData = null;
        let activePenalties = [];
        let teamPlayers = [];
        let pendingGoalTeam = null;
        let fullTimeline = []; // On va stocker les events ici pour les stats

        async function init() {
            // 1. Charger les donn√©es du match
            const { data: m } = await supabaseClient.from('matches').select('*').eq('id', MATCH_ID).single();
            matchData = m;
            
            // 2. Charger les joueurs depuis la table
            const { data: pList } = await supabaseClient.from('players').select('*').eq('match_id', MATCH_ID).order('number');
            teamPlayers = pList || [];

            // 3. Charger l'historique de la timeline
            const { data: tHistory } = await supabaseClient.from('timeline').select('*').eq('match_id', MATCH_ID).order('created_at', { ascending: true });
            if (tHistory && tHistory.length > 0) {
                document.getElementById('timeline-container').innerHTML = '';
                tHistory.forEach(event => addEventToUI(event));
            }

            // 4. Ecoute Realtime
            supabaseClient.channel('match-live').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, p => { matchData = p.new; updateDOM(); }).subscribe();
            supabaseClient.channel('penalties-live').on('postgres_changes', { event: '*', schema: 'public', table: 'penalties' }, () => reloadPenalties()).subscribe();
            supabaseClient.channel('timeline-live').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'timeline' }, p => addEventToUI(p.new)).subscribe();

            // Check Admin
            if (new URLSearchParams(window.location.search).get('admin') === ADMIN_SECRET) {
                document.getElementById('admin-panel').classList.remove('hidden');
            }
            
            reloadPenalties();
            setInterval(refreshTimers, 100);
            updateDOM();
        }

        function updateDOM() {
            if (!matchData) return;
            document.getElementById('score-home').innerText = matchData.score_home;
            document.getElementById('score-away').innerText = matchData.score_away;
            document.getElementById('home-name').innerText = matchData.home_team;
            document.getElementById('away-name').innerText = matchData.away_team;
            document.getElementById('display-location').innerText = matchData.match_location || "Handball";
            document.getElementById('display-start-time').innerText = matchData.match_start_time || "--:--";
            document.getElementById('display-period').innerText = matchData.period;
            
            if (matchData.home_logo_url) { const img = document.getElementById('home-logo'); img.src = matchData.home_logo_url; img.classList.remove('hidden'); }
            if (matchData.away_logo_url) { const img = document.getElementById('away-logo'); img.src = matchData.away_logo_url; img.classList.remove('hidden'); }
            
            const btn = document.getElementById('btn-timer');
            btn.innerText = matchData.is_running ? 'PAUSE' : 'START';
            btn.className = matchData.is_running ? 'px-10 py-3 rounded-full font-bold bg-red-600 text-white' : 'px-10 py-3 rounded-full font-bold bg-green-500 text-black';
        }

        async function updateScore(col, inc) {
            if (inc > 0) {
                pendingGoalTeam = col;
                openPlayerModal(col);
            } else {
                const { data } = await supabaseClient.from('matches').select(col).eq('id', MATCH_ID).single();
                await supabaseClient.from('matches').update({ [col]: Math.max(0, data[col] - 1) }).eq('id', MATCH_ID);
            }
        }

        function openPlayerModal(team) {
            const list = document.getElementById('players-list');
            list.innerHTML = '';
            // On n'affiche les joueurs que pour l'√©quipe domicile
            if (team === 'score_home') {
                teamPlayers.forEach(p => {
                    const b = document.createElement('button');
                    b.className = "bg-slate-800 p-3 rounded-xl text-[11px] font-bold border border-slate-700 hover:bg-indigo-600 transition-colors";
                    b.innerText = `#${p.number} ${p.name}`;
                    b.onclick = () => confirmGoal(`${p.name} (#${p.number})`);
                    list.appendChild(b);
                });
            } else {
                list.innerHTML = '<p class="col-span-2 text-slate-600 text-[10px] italic text-center py-4 uppercase font-bold">√âquipe Ext√©rieure</p>';
            }
            document.getElementById('player-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('player-modal').classList.add('hidden'); }

        async function confirmGoal(playerName) {
            const col = pendingGoalTeam;
            // 1. Calculer le score APRES le but pour la timeline
            const { data } = await supabaseClient.from('matches').select(col).eq('id', MATCH_ID).single();
            const newVal = data[col] + 1;
            
            // 2. Update du score
            await supabaseClient.from('matches').update({ [col]: newVal }).eq('id', MATCH_ID);

            // 3. Pr√©parer le snapshot du score
            const sH = col === 'score_home' ? newVal : matchData.score_home;
            const sA = col === 'score_away' ? newVal : matchData.score_away;

            // 4. Enregistrer dans la Timeline
            await supabaseClient.from('timeline').insert({
                match_id: MATCH_ID,
                event_type: col === 'score_home' ? 'goal_home' : 'goal_away',
                match_time: document.getElementById('timer-display').innerText,
                score_snapshot: `${sH}-${sA}`,
                player_name: playerName
            });
            closeModal();
        }

        async function logGkSave() {
            // On ins√®re l'√©v√©nement avec un score snapshot pour la coh√©rence des stats
            await supabaseClient.from('timeline').insert({
                match_id: MATCH_ID,
                event_type: 'gk_save',
                match_time: document.getElementById('timer-display').innerText,
                score_snapshot: `${matchData.score_home}-${matchData.score_away}`
            });
            // Note: Le Realtime va d√©tecter l'insertion, appeler addEventToUI, 
            // et calculateStats() sera mis √† jour sans cr√©er de ligne dans la timeline.
}       

        function addEventToUI(event) {
            const container = document.getElementById('timeline-container');
            
            // VERROU ANTI-DOUBLONS : Si l'√©v√©nement est d√©j√† dans la liste, on arr√™te TOUT
            if (fullTimeline.some(e => e.id === event.id)) return;

            // On ajoute l'√©v√©nement √† la liste globale
            fullTimeline.push(event);

            // On lance le calcul des stats (qui lira la liste propre)
            calculateStats();

            // FILTRE D'AFFICHAGE : On ne veut pas voir les arr√™ts GB dans la timeline
            if (event.event_type === 'gk_save') return;

            // --- RENDU VISUEL DE LA TIMELINE ---
            if (container.innerText.includes("attente")) container.innerHTML = '';

            const isPeriod = event.event_type === 'period_change';
            const div = document.createElement('div');
            div.className = `flex items-center gap-3 p-3 rounded-2xl border mb-2 shadow-sm ${
                isPeriod ? 'bg-amber-500/10 border-amber-500/30 border-l-4 border-l-amber-500' : 'bg-slate-900/60 border-slate-800'
            }`;
            
            let icon = "ü§æ", label = "", team = "";
            if (event.event_type.includes('goal')) {
                team = event.event_type.includes('home') ? matchData.home_team : matchData.away_team;
        
                // Si on a un joueur, on l'affiche, sinon on affiche "de + nom de l'√©quipe"
                const buteurInfo = event.player_name 
                    ? ` de <span class="text-white">${event.player_name}</span>` 
                    : ` de <span class="text-slate-300">${team}</span>`;
                    
                label = `<span class="text-amber-400 font-black">BUT</span>${buteurInfo}`;
                icon = "ü§æ";
            }
            else if (event.event_type.includes('penalty')) {
                label = "<span class='text-orange-500 text-[10px]'>EXCLUSION 2'</span>"; icon = "‚úåÔ∏è";
                team = event.event_type.includes('home') ? matchData.home_team : matchData.away_team;
            } else if (isPeriod) {
                if (event.player_name === "Mi-Temps") { icon = "‚òï"; label = "Mi-Temps"; }
                else if (event.player_name === "2√®me P√©riode") { icon = "üèÉ"; label = "REPRISE DU MATCH"; }
                else if (event.player_name === "Match Termin√©") { icon = "üèÅ"; label = "FIN DU MATCH"; }
                team = "INFO";
            }

            div.innerHTML = `
                <span class="score-font text-amber-500/50 text-[10px] w-9">${event.match_time}</span>
                <div class="flex-1 leading-tight">
                    <div class="text-[8px] text-slate-500 uppercase font-black">${team}</div>
                    <div class="text-xs font-bold text-slate-300">${label} <span class="text-slate-500 ml-1 text-[10px]">(${event.score_snapshot})</span></div>
                </div>
                <span class="text-lg">${icon}</span>
            `;
            container.prepend(div);
        }

        async function toggleTimer() {
            const now = new Date().toISOString();
            if (!matchData.is_running) {
                await supabaseClient.from('matches').update({ is_running: true, last_start_time: now }).eq('id', MATCH_ID);
            } else {
                const added = Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
                await supabaseClient.from('matches').update({ is_running: false, timer_seconds: matchData.timer_seconds + added, last_start_time: null }).eq('id', MATCH_ID);
            }
        }

        async function adjustTimer(s) {
            let total = getCurrentMatchSeconds();
            let newVal = Math.max(0, total + s);
            const update = { timer_seconds: newVal };
            if (matchData.is_running) update.last_start_time = new Date().toISOString();
            await supabaseClient.from('matches').update(update).eq('id', MATCH_ID);
        }

        function getCurrentMatchSeconds() {
            if (!matchData) return 0;
            let t = matchData.timer_seconds;
            if (matchData.is_running && matchData.last_start_time) {
                t += Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
            }
            return t;
        }

        function refreshTimers() {
            const s = getCurrentMatchSeconds();
            document.getElementById('timer-display').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            renderPenalties('home', s); 
            renderPenalties('away', s);
        }

        function renderPenalties(team, s) {
            const c = document.getElementById(`penalties-${team}`);
            const active = activePenalties.filter(p => p.team === team && p.ends_at_match_seconds > s);
            c.innerHTML = active.map(p => {
                const r = p.ends_at_match_seconds - s;
                return `<div class="bg-orange-600 text-black text-[9px] font-black py-1 px-2 rounded-lg animate-pulse">2' - ${Math.floor(r/60)}:${(r%60).toString().padStart(2,'0')}</div>`;
            }).join('');
        }

        async function reloadPenalties() { const { data } = await supabaseClient.from('penalties').select('*').eq('match_id', MATCH_ID); activePenalties = data || []; }

        async function changePeriod(p) { 
            await supabaseClient.from('matches').update({ period: p }).eq('id', MATCH_ID); 
            await supabaseClient.from('timeline').insert({ 
                match_id: MATCH_ID, 
                event_type: 'period_change', 
                match_time: document.getElementById('timer-display').innerText, 
                score_snapshot: `${matchData.score_home}-${matchData.score_away}`, 
                player_name: p 
            });
        }

        async function addPenalty(team) {
            const end = getCurrentMatchSeconds() + 120;
            await supabaseClient.from('penalties').insert({ match_id: MATCH_ID, team, ends_at_match_seconds: end });
            await supabaseClient.from('timeline').insert({ 
                match_id: MATCH_ID, 
                event_type: team === 'home' ? 'penalty_home' : 'penalty_away', 
                match_time: document.getElementById('timer-display').innerText, 
                score_snapshot: `${matchData.score_home}-${matchData.score_away}` 
            });
        }

        function calculateStats() {
            // --- 1. STATS GARDIEN ---
            // Uniquement les arr√™ts du GB
            const saves = fullTimeline.filter(e => e.event_type === 'gk_save').length;
            // Uniquement les buts encaiss√©s (ceux de l'adversaire)
            const goalsConceded = fullTimeline.filter(e => e.event_type === 'goal_away').length;
            
            const totalShotsAgainst = saves + goalsConceded;
            const percent = totalShotsAgainst > 0 ? Math.round((saves / totalShotsAgainst) * 100) : 0;
            
            document.getElementById('stats-gk-percent').innerText = `${percent}%`;
            document.getElementById('stats-gk-details').innerText = `${saves} Arr√™t${saves > 1 ? 's' : ''} / ${totalShotsAgainst} Tir${totalShotsAgainst > 1 ? 's' : ''}`;

            // --- 2. TOP BUTEURS ---
            // Uniquement les buts marqu√©s par ton √©quipe (home) avec un nom de joueur
            const homeGoals = fullTimeline.filter(e => e.event_type === 'goal_home' && e.player_name);
            const counts = {};
            homeGoals.forEach(g => {
                counts[g.player_name] = (counts[g.player_name] || 0) + 1;
            });

            const sortedScorers = Object.entries(counts)
                .sort((a, b) => b[1] - a[1]) // Du plus grand au plus petit
                .slice(0, 3); // Garde les 3 premiers

            const container = document.getElementById('stats-scorers');
            if (sortedScorers.length > 0) {
                container.innerHTML = sortedScorers.map(([name, count]) => `
                    <div class="flex justify-between items-center border-b border-slate-800/50 pb-1">
                        <span class="text-[11px] font-bold text-slate-300 truncate mr-2">${name}</span>
                        <span class="score-font text-amber-400 text-xs">${count}</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-[10px] text-slate-600 italic">Aucun buteur...</p>';
            }
        }
        async function resetTimer() { 
            if(confirm("R√©initialiser tout le match ?")) { 
                await supabaseClient.from('matches').update({ is_running: false, timer_seconds: 0, last_start_time: null, score_home: 0, score_away: 0, period: '1√®re M-T' }).eq('id', MATCH_ID); 
                await supabaseClient.from('penalties').delete().eq('match_id', MATCH_ID); 
                await supabaseClient.from('timeline').delete().eq('match_id', MATCH_ID); 
                location.reload(); 
            }
        }

        init();
    </script>
</body>
</html>
