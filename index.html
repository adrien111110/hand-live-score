<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Live - Score & Penalties</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style> .score-font { font-family: 'Orbitron', sans-serif; } </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center p-4">

    <div class="mt-6 text-center">
        <div id="timer-display" class="score-font text-5xl text-amber-400">00:00</div>
    </div>

    <div class="w-full max-w-lg mt-8 bg-slate-900 rounded-3xl p-6 shadow-2xl border border-slate-800">
        <div class="flex justify-between items-start">
            <div class="flex-1 text-center">
                <h2 id="home-name" class="text-xs font-bold text-slate-500 mb-2 uppercase">MAISON</h2>
                <div id="score-home" class="score-font text-7xl mb-4">0</div>
                <div id="penalties-home" class="space-y-2"></div>
            </div>

            <div class="text-4xl text-slate-800 font-bold mt-8">:</div>

            <div class="flex-1 text-center">
                <h2 id="away-name" class="text-xs font-bold text-slate-500 mb-2 uppercase">EXT√âRIEUR</h2>
                <div id="score-away" class="score-font text-7xl mb-4">0</div>
                <div id="penalties-away" class="space-y-2"></div>
            </div>
        </div>
    </div>
    
    <div class="w-full max-w-lg mt-6">
        <h3 class="text-[10px] uppercase tracking-widest text-slate-500 mb-3 px-2 font-bold">Fil du match</h3>
        <div id="timeline-container" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
            <p class="text-slate-600 text-xs italic p-4 text-center">Le match n'a pas encore d√©but√©...</p>
        </div>
    </div>
    
    <div id="admin-panel" class="hidden w-full max-w-md mt-8 space-y-6 bg-slate-900/80 p-6 rounded-3xl border border-slate-700">
        <div class="flex justify-center gap-4">
            <button onclick="toggleTimer()" id="btn-timer" class="px-8 py-2 rounded-full font-bold bg-green-500 text-black">START</button>
            <button onclick="resetTimer()" class="text-xs text-slate-500 uppercase">Reset</button>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <div class="space-y-3">
                <button onclick="updateScore('score_home', 1)" class="w-full bg-white text-black font-bold py-4 rounded-xl">+1 BUT</button>
                <button onclick="addPenalty('home')" class="w-full bg-orange-600/20 border border-orange-600 text-orange-500 py-2 rounded-lg text-xs font-bold">EXCLUSION 2'</button>
            </div>
            <div class="space-y-3">
                <button onclick="updateScore('score_away', 1)" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl">+1 BUT</button>
                <button onclick="addPenalty('away')" class="w-full bg-orange-600/20 border border-orange-600 text-orange-500 py-2 rounded-lg text-xs font-bold">EXCLUSION 2'</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://rmfcixwuyltwpotijozd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZmNpeHd1eWx0d3BvdGlqb3pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjQyMzgsImV4cCI6MjA4NTYwMDIzOH0.IW9b7431_xQlM1rydhOO551QgIq3bVEOgM5KllSzfTs';
        const MATCH_ID = 'd470bcc2-8b48-4881-8c9f-ac25c9002d2e';
        const ADMIN_SECRET = "coach2026"; 

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    let matchData = null;
    let activePenalties = [];

    async function init() {
            // 1. Charger les donn√©es du match
        const m = await supabaseClient.from('matches').select('*').eq('id', MATCH_ID).single();
        matchData = m.data;
        
        // 2. Charger les p√©nalit√©s actives
        const p = await supabaseClient.from('penalties').select('*').eq('match_id', MATCH_ID);
        activePenalties = p.data || [];
    
        // 3. Charger TOUTE la Timeline pass√©e (AJOUT ICI)
        const t = await supabaseClient
            .from('timeline')
            .select('*')
            .eq('match_id', MATCH_ID)
            .order('created_at', { ascending: true }); // On les prend dans l'ordre chronologique
        
        if (t.data) {
            // On vide le container au cas o√π
            document.getElementById('timeline-container').innerHTML = '';
            // On les affiche un par un
            t.data.forEach(event => addEventToUI(event));
        }
    
        updateDOM();

        supabaseClient.channel('match-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, payload => {
            matchData = payload.new;
            updateDOM();
        }).subscribe();

        supabaseClient.channel('penalty-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'penalties' }, payload => {
            if (payload.eventType === 'INSERT') activePenalties.push(payload.new);
            if (payload.eventType === 'DELETE' || (payload.eventType === 'UPDATE' && payload.new.match_id !== MATCH_ID)) {
                activePenalties = activePenalties.filter(x => x.id !== (payload.old?.id || payload.new.id));
            }
            // Pour simplifier, on recharge tout si on a un doute
            if (payload.eventType === 'DELETE') reloadPenalties();
        }).subscribe();

        supabaseClient.channel('timeline-updates').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'timeline' }, payload => {
            addEventToUI(payload.new);
        }).subscribe();

        if (new URLSearchParams(window.location.search).get('admin') === ADMIN_SECRET) 
            document.getElementById('admin-panel').classList.remove('hidden');

        setInterval(refreshTimers, 100); // Plus pr√©cis (100ms) pour le chrono
    }

    async function logEvent(type) {
        const matchTime = document.getElementById('timer-display').innerText;
        const score = `${matchData.score_home} - ${matchData.score_away}`;
    
        await supabaseClient.from('timeline').insert({
            match_id: MATCH_ID,
            event_type: type,
            match_time: matchTime,
            score_snapshot: score
        });
    }
        
    async function reloadPenalties() {
        const p = await supabaseClient.from('penalties').select('*').eq('match_id', MATCH_ID);
        activePenalties = p.data || [];
    }

    function getCurrentMatchSeconds() {
        if (!matchData) return 0;
        let total = matchData.timer_seconds;
        if (matchData.is_running && matchData.last_start_time) {
            total += Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
        }
        return total;
    }

    function refreshTimers() {
        const matchSec = getCurrentMatchSeconds();
        
        // Affichage Chrono Match
        document.getElementById('timer-display').innerText = 
            `${Math.floor(matchSec/60).toString().padStart(2,'0')}:${(matchSec%60).toString().padStart(2,'0')}`;

        // Affichage P√©nalit√©s
        renderPenalties('home', matchSec);
        renderPenalties('away', matchSec);
    }

    function renderPenalties(team, currentMatchSec) {
        const container = document.getElementById(`penalties-${team}`);
        // On affiche les p√©nalit√©s dont le temps de match de fin est dans le futur
        const current = activePenalties.filter(p => p.team === team && p.ends_at_match_seconds > currentMatchSec);
        
        container.innerHTML = current.map(p => {
            const remaining = p.ends_at_match_seconds - currentMatchSec;
            const m = Math.floor(remaining/60);
            const s = remaining%60;
            return `<div class="bg-orange-600 text-black text-[10px] font-bold py-1 px-2 rounded ${matchData.is_running ? 'animate-pulse' : ''}">
                2' - ${m}:${s.toString().padStart(2,'0')}
            </div>`;
        }).join('');
    }
        
    function addEventToUI(event) {
        const container = document.getElementById('timeline-container');
        
        // Supprimer le message "en attente" s'il existe
        const emptyMsg = container.querySelector('p');
        if (emptyMsg) emptyMsg.remove();
    
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 bg-slate-900/50 p-3 rounded-xl border border-slate-800 mb-2";
        
        const isGoal = event.event_type.includes('goal');
        const icon = isGoal ? '‚öΩ' : 'üüß';
        const teamName = event.event_type.includes('home') ? matchData.home_team : matchData.away_team;
        
        let label = "";
        if (event.event_type === 'goal_home' || event.event_type === 'goal_away') label = "BUT !";
        if (event.event_type === 'penalty_home' || event.event_type === 'penalty_away') label = "EXCLUSION 2'";
    
        div.innerHTML = `
            <span class="score-font text-amber-400 text-[10px] w-10">${event.match_time}</span>
            <div class="flex-1">
                <div class="text-[8px] text-slate-500 font-bold uppercase">${teamName}</div>
                <div class="text-xs font-bold">${label} (${event.score_snapshot})</div>
            </div>
            <span class="text-lg">${icon}</span>
        `;
    
        // .prepend() ajoute l'√©l√©ment au d√©but de la liste (en haut)
        // C'est ce qu'on veut pour que le dernier √©v√©nement soit le plus visible
        container.prepend(div);
    }

    // ACTIONS ADMIN
    async function addPenalty(team) {
        const endsAtMatch = getCurrentMatchSeconds() + 120;
        await supabaseClient.from('penalties').insert({ 
            match_id: MATCH_ID, team, ends_at_match_seconds: endsAtMatch 
        });
        logEvent(team === 'home' ? 'penalty_home' : 'penalty_away');
    }

    async function toggleTimer() {
        const now = new Date().toISOString();
        if (!matchData.is_running) {
            await supabaseClient.from('matches').update({ is_running: true, last_start_time: now }).eq('id', MATCH_ID);
        } else {
            const added = Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
            await supabaseClient.from('matches').update({ 
                is_running: false, 
                timer_seconds: matchData.timer_seconds + added, 
                last_start_time: null 
            }).eq('id', MATCH_ID);
        }
    }

    async function updateScore(col, inc) {
        const { data } = await supabaseClient.from('matches').select(col).eq('id', MATCH_ID).single();
        const newScore = Math.max(0, data[col] + inc);
        await supabaseClient.from('matches').update({ [col]: newScore }).eq('id', MATCH_ID);
    
        if (inc > 0) {
            logEvent(col === 'score_home' ? 'goal_home' : 'goal_away');
        }
    }

    async function resetTimer() {
        if(confirm("Tout remettre √† z√©ro (match + p√©nalit√©s + historique) ?")) {
            // Reset match
            await supabaseClient.from('matches').update({ 
                is_running: false, 
                timer_seconds: 0, 
                last_start_time: null,
                score_home: 0,
                score_away: 0
            }).eq('id', MATCH_ID);
    
            // Supprimer p√©nalit√©s
            await supabaseClient.from('penalties').delete().eq('match_id', MATCH_ID);
    
            // Supprimer Timeline (AJOUT ICI)
            await supabaseClient.from('timeline').delete().eq('match_id', MATCH_ID);
            
            // Rafra√Æchir l'√©cran localement
            location.reload(); 
        }
    }

    function updateDOM() {
        document.getElementById('score-home').innerText = matchData.score_home;
        document.getElementById('score-away').innerText = matchData.score_away;
        document.getElementById('home-name').innerText = matchData.home_team;
        document.getElementById('away-name').innerText = matchData.away_team;
        const btn = document.getElementById('btn-timer');
        btn.innerText = matchData.is_running ? 'PAUSE' : 'START';
        btn.className = matchData.is_running ? 'px-8 py-2 rounded-full font-bold bg-red-500 text-white' : 'px-8 py-2 rounded-full font-bold bg-green-500 text-black';
    }

    init();
</script>
</body>
</html>
