<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Live Pro - SCHL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style> .score-font { font-family: 'Orbitron', sans-serif; } </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-lg mb-4 px-4 flex flex-col items-center">
        <div class="flex items-center gap-2 text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">
            <span id="display-location">Lieu du match</span>
            <span class="text-slate-700">‚Ä¢</span>
            <span id="display-start-time">--:--</span>
        </div>
        <div id="display-period" class="mt-2 bg-slate-800 text-slate-300 text-[9px] px-2 py-0.5 rounded-full border border-slate-700 font-bold uppercase tracking-wider">1√®re M-T</div>
    </div>

    <div class="text-center mb-6">
        <div id="timer-display" class="score-font text-5xl text-amber-400">00:00</div>
    </div>

    <div class="w-full max-w-lg bg-slate-900 rounded-3xl p-6 shadow-2xl border border-slate-800">
        <div class="flex justify-between items-start">
            <div class="flex-1 text-center flex flex-col items-center">
                <img id="home-logo" src="" class="w-12 h-12 mb-2 object-contain hidden" alt="">
                <h2 id="home-name" class="text-xs font-bold text-slate-500 mb-2 uppercase">MAISON</h2>
                <div id="score-home" class="score-font text-6xl mb-4">0</div>
                <div id="penalties-home" class="space-y-2 w-full"></div>
            </div>
            <div class="text-4xl text-slate-800 font-bold mt-16">:</div>
            <div class="flex-1 text-center flex flex-col items-center">
                <img id="away-logo" src="" class="w-12 h-12 mb-2 object-contain hidden" alt="">
                <h2 id="away-name" class="text-xs font-bold text-slate-500 mb-2 uppercase">EXT√âRIEUR</h2>
                <div id="score-away" class="score-font text-6xl mb-4">0</div>
                <div id="penalties-away" class="space-y-2 w-full"></div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-lg mt-6">
        <h3 class="text-[10px] uppercase tracking-widest text-slate-500 mb-3 px-2 font-bold italic">Fil du match</h3>
        <div id="timeline-container" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
    </div>

    <div id="admin-panel" class="hidden w-full max-w-md mt-8 space-y-6 bg-slate-900/90 p-6 rounded-3xl border border-slate-700 shadow-2xl">
        <div class="flex flex-col items-center gap-4">
            <select id="select-period" onchange="changePeriod(this.value)" class="bg-slate-800 text-white text-xs p-2 rounded-lg border border-slate-700 w-full">
                <option value="1√®re M-T">1√®re Mi-temps</option>
                <option value="Pause">Pause</option>
                <option value="2√®me M-T">2√®me Mi-temps</option>
                <option value="Match Termin√©">Match Termin√©</option>
            </select>
            <div class="flex items-center gap-4">
                <button onclick="adjustTimer(-10)" class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 text-slate-400">-10</button>
                <button id="btn-timer" onclick="toggleTimer()" class="px-8 py-3 rounded-full font-bold bg-green-500 text-black shadow-lg shadow-green-500/20">START</button>
                <button onclick="adjustTimer(10)" class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 text-slate-400">+10</button>
            </div>
            <button onclick="resetTimer()" class="text-[9px] text-slate-600 uppercase tracking-widest">Reset Complet</button>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-slate-800">
            <div class="space-y-2">
                <button onclick="updateScore('score_home', 1)" class="w-full bg-white text-black font-bold py-4 rounded-xl">+1 BUT</button>
                <button onclick="addPenalty('home')" class="w-full bg-orange-600/10 border border-orange-600/50 text-orange-500 py-2 rounded-lg text-[10px] font-bold">2 MIN</button>
            </div>
            <div class="space-y-2">
                <button onclick="updateScore('score_away', 1)" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl">+1 BUT</button>
                <button onclick="addPenalty('away')" class="w-full bg-orange-600/10 border border-orange-600/50 text-orange-500 py-2 rounded-lg text-[10px] font-bold">2 MIN</button>
            </div>
        </div>
    </div>

    <div id="player-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <button onclick="confirmGoal(null)" class="w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl mb-4 font-bold border border-slate-700">üë§ Buteur Inconnu</button>
            <div id="players-list" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto pr-2"></div>
            <button onclick="closeModal()" class="w-full mt-6 text-slate-500 text-xs uppercase">Annuler</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'TON_URL';
        const supabaseKey = 'TA_CLE_ANON';
        const MATCH_ID = 'TON_ID_MATCH';
        const ADMIN_SECRET = "coach2026";
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let matchData = null;
        let activePenalties = [];
        let teamPlayers = [];
        let pendingGoalTeam = null;

        async function init() {
            // Charger Match
            const { data: m } = await supabaseClient.from('matches').select('*').eq('id', MATCH_ID).single();
            matchData = m;
            
            // Charger Joueurs
            const { data: pList } = await supabaseClient.from('players').select('*').eq('match_id', MATCH_ID).order('number');
            teamPlayers = pList || [];

            // Charger Historique Timeline
            const { data: t } = await supabaseClient.from('timeline').select('*').eq('match_id', MATCH_ID).order('created_at', { ascending: true });
            if (t) {
                document.getElementById('timeline-container').innerHTML = '';
                t.forEach(event => addEventToUI(event));
            }

            // Realtime
            supabaseClient.channel('live').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, p => { matchData = p.new; updateDOM(); }).subscribe();
            supabaseClient.channel('pen').on('postgres_changes', { event: '*', schema: 'public', table: 'penalties' }, p => { reloadPenalties(); }).subscribe();
            supabaseClient.channel('time').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'timeline' }, p => { addEventToUI(p.new); }).subscribe();

            if (new URLSearchParams(window.location.search).get('admin') === ADMIN_SECRET) document.getElementById('admin-panel').classList.remove('hidden');
            
            reloadPenalties();
            setInterval(refreshTimers, 100);
            updateDOM();
        }

        function updateDOM() {
            document.getElementById('score-home').innerText = matchData.score_home;
            document.getElementById('score-away').innerText = matchData.score_away;
            document.getElementById('home-name').innerText = matchData.home_team;
            document.getElementById('away-name').innerText = matchData.away_team;
            document.getElementById('display-location').innerText = matchData.match_location || "Gymnase";
            document.getElementById('display-start-time').innerText = matchData.match_start_time || "--:--";
            document.getElementById('display-period').innerText = matchData.period;
            
            if (matchData.home_logo_url) { const l = document.getElementById('home-logo'); l.src = matchData.home_logo_url; l.classList.remove('hidden'); }
            if (matchData.away_logo_url) { const l = document.getElementById('away-logo'); l.src = matchData.away_logo_url; l.classList.remove('hidden'); }
            
            const btn = document.getElementById('btn-timer');
            btn.innerText = matchData.is_running ? 'PAUSE' : 'START';
            btn.className = matchData.is_running ? 'px-8 py-3 rounded-full font-bold bg-red-600 text-white' : 'px-8 py-3 rounded-full font-bold bg-green-500 text-black';
        }

        async function updateScore(col, inc) {
            if (inc > 0) {
                pendingGoalTeam = col;
                openModal(col);
            } else {
                const { data } = await supabaseClient.from('matches').select(col).eq('id', MATCH_ID).single();
                await supabaseClient.from('matches').update({ [col]: Math.max(0, data[col] - 1) }).eq('id', MATCH_ID);
            }
        }

        function openModal(team) {
            const list = document.getElementById('players-list');
            list.innerHTML = '';
            if (team === 'score_home') {
                teamPlayers.forEach(p => {
                    const b = document.createElement('button');
                    b.className = "bg-slate-800 p-3 rounded-xl text-xs font-bold border border-slate-700";
                    b.innerText = `#${p.number} ${p.name}`;
                    b.onclick = () => confirmGoal(`#${p.number} ${p.name}`);
                    list.appendChild(b);
                });
            } else {
                list.innerHTML = '<p class="col-span-2 text-slate-600 text-[10px] italic text-center py-4">Equipe adverse</p>';
            }
            document.getElementById('player-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('player-modal').classList.add('hidden'); }

        async function confirmGoal(playerName) {
            const col = pendingGoalTeam;
            const { data } = await supabaseClient.from('matches').select(col).eq('id', MATCH_ID).single();
            const newVal = data[col] + 1;
            await supabaseClient.from('matches').update({ [col]: newVal }).eq('id', MATCH_ID);

            const sH = col === 'score_home' ? newVal : matchData.score_home;
            const sA = col === 'score_away' ? newVal : matchData.score_away;

            await supabaseClient.from('timeline').insert({
                match_id: MATCH_ID,
                event_type: col === 'score_home' ? 'goal_home' : 'goal_away',
                match_time: document.getElementById('timer-display').innerText,
                score_snapshot: `${sH} - ${sA}`,
                player_name: playerName
            });
            closeModal();
        }

        function addEventToUI(event) {
            const container = document.getElementById('timeline-container');
            if (container.querySelector('p')) container.innerHTML = '';
            const isPeriod = event.event_type === 'period_change';
            const div = document.createElement('div');
            div.className = `flex items-center gap-3 p-3 rounded-xl border mb-2 ${isPeriod ? 'bg-amber-500/10 border-amber-500/30 border-l-4 border-l-amber-500' : 'bg-slate-900/50 border-slate-800'}`;
            
            let icon = "‚öΩ", label = "", team = "";
            if (event.event_type.includes('goal')) {
                label = `BUT${event.player_name ? ' de ' + event.player_name : ''} !`;
                team = event.event_type.includes('home') ? matchData.home_team : matchData.away_team;
            } else if (event.event_type.includes('penalty')) {
                label = "EXCLUSION 2'"; icon = "üüß";
                team = event.event_type.includes('home') ? matchData.home_team : matchData.away_team;
            } else if (isPeriod) {
                label = event.player_name; icon = "üèÅ"; team = "MATCH";
            }

            div.innerHTML = `<span class="score-font text-amber-400 text-[10px] w-10">${event.match_time}</span>
                <div class="flex-1 leading-tight"><div class="text-[8px] text-slate-500 uppercase font-bold">${team}</div>
                <div class="text-xs font-bold">${label} (${event.score_snapshot})</div></div><span>${icon}</span>`;
            container.prepend(div);
        }

        async function toggleTimer() {
            const now = new Date().toISOString();
            if (!matchData.is_running) {
                await supabaseClient.from('matches').update({ is_running: true, last_start_time: now }).eq('id', MATCH_ID);
            } else {
                const added = Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
                await supabaseClient.from('matches').update({ is_running: false, timer_seconds: matchData.timer_seconds + added, last_start_time: null }).eq('id', MATCH_ID);
            }
        }

        async function adjustTimer(s) {
            let total = getCurrentMatchSeconds();
            let newVal = Math.max(0, total + s);
            const up = { timer_seconds: newVal };
            if (matchData.is_running) up.last_start_time = new Date().toISOString();
            await supabaseClient.from('matches').update(up).eq('id', MATCH_ID);
        }

        function getCurrentMatchSeconds() {
            if (!matchData) return 0;
            let t = matchData.timer_seconds;
            if (matchData.is_running && matchData.last_start_time) t += Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
            return t;
        }

        function refreshTimers() {
            const s = getCurrentMatchSeconds();
            document.getElementById('timer-display').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            renderPenalties('home', s); renderPenalties('away', s);
        }

        function renderPenalties(team, s) {
            const c = document.getElementById(`penalties-${team}`);
            const active = activePenalties.filter(p => p.team === team && p.ends_at_match_seconds > s);
            c.innerHTML = active.map(p => {
                const r = p.ends_at_match_seconds - s;
                return `<div class="bg-orange-600 text-black text-[9px] font-bold py-1 px-2 rounded">2' - ${Math.floor(r/60)}:${(r%60).toString().padStart(2,'0')}</div>`;
            }).join('');
        }

        async function reloadPenalties() { const { data } = await supabaseClient.from('penalties').select('*').eq('match_id', MATCH_ID); activePenalties = data || []; }
        async function changePeriod(p) { 
            await supabaseClient.from('matches').update({ period: p }).eq('id', MATCH_ID); 
            await supabaseClient.from('timeline').insert({ match_id: MATCH_ID, event_type: 'period_change', match_time: document.getElementById('timer-display').innerText, score_snapshot: `${matchData.score_home} - ${matchData.score_away}`, player_name: p });
        }
        async function addPenalty(team) {
            const end = getCurrentMatchSeconds() + 120;
            await supabaseClient.from('penalties').insert({ match_id: MATCH_ID, team, ends_at_match_seconds: end });
            await supabaseClient.from('timeline').insert({ match_id: MATCH_ID, event_type: team === 'home' ? 'penalty_home' : 'penalty_away', match_time: document.getElementById('timer-display').innerText, score_snapshot: `${matchData.score_home} - ${matchData.score_away}` });
        }
        async function resetTimer() { if(confirm("Reset?")) { await supabaseClient.from('matches').update({ is_running: false, timer_seconds: 0, last_start_time: null, score_home: 0, score_away: 0 }).eq('id', MATCH_ID); await supabaseClient.from('penalties').delete().eq('match_id', MATCH_ID); await supabaseClient.from('timeline').delete().eq('match_id', MATCH_ID); location.reload(); }}

        init();
    </script>
</body>
</html>
