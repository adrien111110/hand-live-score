<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Live - Score & Penalties</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style> .score-font { font-family: 'Orbitron', sans-serif; } </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center p-4">

    <div class="mt-6 text-center">
        <div id="timer-display" class="score-font text-5xl text-amber-400">00:00</div>
    </div>

    <div class="w-full max-w-lg mt-8 bg-slate-900 rounded-3xl p-6 shadow-2xl border border-slate-800">
        <div class="flex justify-between items-start">
            <div class="flex-1 text-center">
                <h2 id="home-name" class="text-xs font-bold text-slate-500 mb-2 uppercase">MAISON</h2>
                <div id="score-home" class="score-font text-7xl mb-4">0</div>
                <div id="penalties-home" class="space-y-2"></div>
            </div>

            <div class="text-4xl text-slate-800 font-bold mt-8">:</div>

            <div class="flex-1 text-center">
                <h2 id="away-name" class="text-xs font-bold text-slate-500 mb-2 uppercase">EXTÉRIEUR</h2>
                <div id="score-away" class="score-font text-7xl mb-4">0</div>
                <div id="penalties-away" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden w-full max-w-md mt-8 space-y-6 bg-slate-900/80 p-6 rounded-3xl border border-slate-700">
        <div class="flex justify-center gap-4">
            <button onclick="toggleTimer()" id="btn-timer" class="px-8 py-2 rounded-full font-bold bg-green-500 text-black">START</button>
            <button onclick="resetTimer()" class="text-xs text-slate-500 uppercase">Reset</button>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <div class="space-y-3">
                <button onclick="updateScore('score_home', 1)" class="w-full bg-white text-black font-bold py-4 rounded-xl">+1 BUT</button>
                <button onclick="addPenalty('home')" class="w-full bg-orange-600/20 border border-orange-600 text-orange-500 py-2 rounded-lg text-xs font-bold">EXCLUSION 2'</button>
            </div>
            <div class="space-y-3">
                <button onclick="updateScore('score_away', 1)" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl">+1 BUT</button>
                <button onclick="addPenalty('away')" class="w-full bg-orange-600/20 border border-orange-600 text-orange-500 py-2 rounded-lg text-xs font-bold">EXCLUSION 2'</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://rmfcixwuyltwpotijozd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtZmNpeHd1eWx0d3BvdGlqb3pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjQyMzgsImV4cCI6MjA4NTYwMDIzOH0.IW9b7431_xQlM1rydhOO551QgIq3bVEOgM5KllSzfTs';
        const MATCH_ID = 'd470bcc2-8b48-4881-8c9f-ac25c9002d2e';
        const ADMIN_SECRET = "coach2026"; 

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        let matchData = null;
        let activePenalties = [];

        async function init() {
            // Initial Load
            const m = await supabaseClient.from('matches').select('*').eq('id', MATCH_ID).single();
            matchData = m.data;
            const p = await supabaseClient.from('penalties').select('*').eq('match_id', MATCH_ID);
            activePenalties = p.data || [];

            updateDOM();

            // Realtime Matches
            supabaseClient.channel('m').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, payload => {
                matchData = payload.new;
                updateDOM();
            }).subscribe();

            // Realtime Penalties
            supabaseClient.channel('p').on('postgres_changes', { event: '*', schema: 'public', table: 'penalties' }, payload => {
                if (payload.eventType === 'INSERT') activePenalties.push(payload.new);
                if (payload.eventType === 'DELETE') activePenalties = activePenalties.filter(x => x.id !== payload.old.id);
                updateDOM();
            }).subscribe();

            if (new URLSearchParams(window.location.search).get('admin') === ADMIN_SECRET) 
                document.getElementById('admin-panel').classList.remove('hidden');

            setInterval(refreshTimers, 1000);
        }

        function updateDOM() {
            document.getElementById('score-home').innerText = matchData.score_home;
            document.getElementById('score-away').innerText = matchData.score_away;
            document.getElementById('home-name').innerText = matchData.home_team;
            document.getElementById('away-name').innerText = matchData.away_team;
            document.getElementById('btn-timer').innerText = matchData.is_running ? 'PAUSE' : 'START';
            document.getElementById('btn-timer').className = matchData.is_running ? 'px-8 py-2 rounded-full font-bold bg-red-500 text-white' : 'px-8 py-2 rounded-full font-bold bg-green-500 text-black';
        }

        function refreshTimers() {
            if (!matchData) return;
            
            // Match Timer
            let total = matchData.timer_seconds;
            if (matchData.is_running && matchData.last_start_time) {
                total += Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
            }
            document.getElementById('timer-display').innerText = `${Math.floor(total/60).toString().padStart(2,'0')}:${(total%60).toString().padStart(2,'0')}`;

            // Penalties
            renderPenalties('home');
            renderPenalties('away');
        }

        function renderPenalties(team) {
            const container = document.getElementById(`penalties-${team}`);
            const now = new Date();
            const current = activePenalties.filter(p => p.team === team && new Date(p.ends_at) > now);
            
            container.innerHTML = current.map(p => {
                const diff = Math.floor((new Date(p.ends_at) - now) / 1000);
                const m = Math.floor(diff/60);
                const s = diff%60;
                return `<div class="bg-orange-600 text-black text-[10px] font-bold py-1 px-2 rounded animate-pulse">2' - ${m}:${s.toString().padStart(2,'0')}</div>`;
            }).join('');
        }

        async function addPenalty(team) {
            const endsAt = new Date(Date.now() + 120 * 1000).toISOString();
            await supabaseClient.from('penalties').insert({ match_id: MATCH_ID, team, ends_at: endsAt });
        }

        // Réutiliser les fonctions updateScore, toggleTimer, resetTimer du code précédent...
        async function toggleTimer() {
            const now = new Date().toISOString();
            if (!matchData.is_running) {
                await supabaseClient.from('matches').update({ is_running: true, last_start_time: now }).eq('id', MATCH_ID);
            } else {
                const added = Math.floor((new Date() - new Date(matchData.last_start_time)) / 1000);
                await supabaseClient.from('matches').update({ is_running: false, timer_seconds: matchData.timer_seconds + added, last_start_time: null }).eq('id', MATCH_ID);
            }
        }

        async function updateScore(col, inc) {
            const { data } = await supabaseClient.from('matches').select(col).eq('id', MATCH_ID).single();
            await supabaseClient.from('matches').update({ [col]: Math.max(0, data[col] + inc) }).eq('id', MATCH_ID);
        }

        async function resetTimer() { if(confirm("Reset?")) await supabaseClient.from('matches').update({ is_running: false, timer_seconds: 0, last_start_time: null }).eq('id', MATCH_ID); }

        init();
    </script>
</body>
</html>
